---
title: "R Notebook"
output:
  html_document:
    df_print: paged
    code_folding: "hide"
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE, message=FALSE)
```

# Plan for dashboards

- (TODO) There should be an introduction or documentation page
- (TODO) First tab will have descriptive stats
  - Have filter based on state, region, etc
  - Group by metro/micro areas
  - Shortages for each state
- Second tab will show by individual states broken by counties
  - (TODO) Will include hospital locations as well
  - (TODO) Will also contain a table to include data for hospitals without locations
- Last tab will show changes in metrics over time for individual hospitals
  - (TODO) Add options to choose metrics (e.g. new cases, percent full, etc.)

# Introduction

> On Monday, the Department of Health and Human Services released a dataset on coronavirus-related capacity at thousands of US hospitals —information the agency previously only published as state-level metrics. The self-reported, weekly-updated dataset quantifies various aspects of capacity, such as the number of staffed ICU beds and the number of beds occupied by patients with COVID-19. “This data is tremendously complex and is the result of substantial ongoing efforts,” notes an accompanying blog post. “We opted not to have perfect be the enemy of good, so these datasets will have imperfections.” Related: An FAQ “developed in collaboration with a group of data journalists, data scientists, and healthcare system researchers who have reviewed the data.” [h/t Ryan Panchadsaram]

[Tweet](https://twitter.com/rypan/status/1336095555852767233)

[Source](https://healthdata.gov/Hospital/COVID-19-Reported-Patient-Impact-and-Hospital-Capa/anag-cw7u)

[Github](https://github.com/CareSet/COVID_Hospital_PUF)

[Hospital Reporting FAQs](https://www.hhs.gov/sites/default/files/covid-19-faqs-hospitals-hospital-laboratory-acute-care-facility-data-reporting.pdf)

Questions from the FAQ found in the data are shown below. These are usually shown as sums or averages in a collection week

- **1 a,b,d**: Hospital information
- **2 a,b**: Total number of staffed inpatient and outpatient beds
  - total_beds_7_day_avg
  - all_adult_hospital_beds_7_day_avg
- **3 a,b**: Total number of staffed inpatient beds
  - inpatient_beds_7_day_avg
  - all_adult_hospital_inpatient_beds_7_day_avg
- **4 a,b**: Total number of staffed inpatient beds that are occupied
  - inpatient_beds_used_7_day_avg
  - all_adult_hospital_inpatient_bed_occupied_7_day_avg
- **5 a,b**: Total number of staffed inpatient ICU beds
  - total_icu_beds_7_day_avg
  - total_staffed_adult_icu_beds_7_day_avg
- **6 a,b**:  Total number of staffed inpatient ICU beds that are occupied
  - icu_beds_used_7_day_avg
  - staffed_adult_icu_bed_occupancy_7_day_avg
- **9 a,b**: Number of patients hospitalized in an adult inpatient bed
  - total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg
  - total_adult_patients_hospitalized_confirmed_covid_7_day_avg
- **10 a,b**: Number of patients hospitalized in a pediatric inpatient bed
  - total_pediatric_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg
  - total_pediatric_patients_hospitalized_confirmed_covid_7_day_avg
- **12 a,b**: Number of patients currently hospitalized in a designated adult ICU bed
  - staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg
  - staffed_icu_adult_patients_confirmed_covid_7_day_avg
- **17 a-a9,b-b9**: Previous day adult COVID patient admission (to inpatient bed)
- **18 a,b**: Previous day pediatric COVID patient admission (to inpatient bed)
<!-- - **19**: Previous day ED visit -->
<!-- - **20**: Previous day COVID-related ED visit -->
<!-- - **33**: # of hospitalized adult influenza patients -->
<!-- - **34**: Previous day adult influenza patient admission (to inpatient bed) -->
<!-- - **35**: # of hospitalized adult influenza patients in ICU -->
<!-- - **36**: # of hospitalized adult with COVID and influenza -->

```{r libraries, message=FALSE}
library(tidyverse)
library(vroom)
library(sf)
library(tigris)
library(tmap)
```

```{r read_and_clean_data, message=FALSE, warning=FALSE}
df <- vroom("data/reported_weekly_facility_level_capacity.csv") %>%
  select(hospital_pk:is_metro_micro, inpatient_beds_7_day_sum, 
         ends_with("avg"), starts_with("previous"),
         geocoded_hospital_address)
```

This dataset contains
`r length(unique(df$collection_week))`
weeks worth of data ( from
`r min(df$collection_week)`
to
`r max(df$collection_week)`
). There are
`r length(unique(df$hospital_pk))`
hospitals reporting. 

Most counties average
` df %>% filter(collection_week == max(collection_week)) %>% count(fips_code) %>% arrange(desc(n)) %>% pull(n) %>% summary() `
hospitals in their area.

They have recently updated the information to include geocoded addresses. This information contains the latitude and longitude of the hospitals.

```{r location_info}
# Keep locations in separate dataframe
locations <- df %>%
  distinct(hospital_pk, state, city, address, zip, geocoded_hospital_address) %>% 
  replace_na(list(geocoded_hospital_address = "POINT EMPTY")) %>%
  st_as_sf(wkt = "geocoded_hospital_address", na.fail = FALSE)


# Remove corresponding column in df 
df <- df %>% 
  select(-c(state, city, address, zip,geocoded_hospital_address))

# left_join(locations, df, by = "hospital_pk", left = FALSE)
```

# Community Profile Report Charts

[Community Profile Report](https://healthdata.gov/Health/COVID-19-Community-Profile-Report/gqxm-d9w9)

HHS produces a community profile through core based statistical areas CBSA

```{r}
state_utilization_timeseries <- vroom("https://healthdata.gov/api/views/g62h-syeh/rows.csv?accessType=DOWNLOAD")
```

```{r daily_hospital_admissions}
theme_set(theme_bw())
state_utilization_timeseries %>% 
  filter(date > lubridate::mdy("Aug 01 2020")) %>% 
  select(state, date,
         previous_day_admission_adult_covid_confirmed,
         previous_day_admission_pediatric_covid_confirmed,
         previous_day_admission_adult_covid_suspected,
         previous_day_admission_pediatric_covid_suspected) %>%
  group_by(date) %>% 
  summarize(confirmed = sum(previous_day_admission_adult_covid_confirmed, previous_day_admission_pediatric_covid_confirmed, na.rm = TRUE),
            suspected = sum(previous_day_admission_adult_covid_suspected, previous_day_admission_pediatric_covid_suspected, na.rm = TRUE)) %>% 
  pivot_longer(c(confirmed, suspected), names_to = "type", values_to = "cases") %>% 
  mutate(type = str_to_title(type),
         type = fct_relevel(type, c("Suspected", "Confirmed"))) %>% 
  ggplot(aes(x = date, y = cases, fill = type)) + 
  geom_col(width = 1) +
  scale_x_date(date_breaks = "month", minor_breaks = NULL,
               date_labels = "%b %y") +
  scale_y_continuous(labels = scales::comma) + 
  expand_limits(y = 0) +
  labs(title = "New Hospital Admissions (Daily)",
       y = "Cases", x = NULL, fill = "Status")
```


# Calculating some metrics

The imported data will have some data cleaning steps. First, we will remove columns related to pediatric patients and change numeric -999,999 values to NA. 
This is done in the data loading file.

```{r impute_999999_values}
impute_999999_values <- function(df, formule) {
  df[rlang::as_function(formule)(df)] <- 0
  df
}

df <- df %>% 
  impute_999999_values(~ .x == -999999)
```

The following are calculations for possibly important metrics. 

| Example Metrics for Adult Hospitalizations  | Formula |
| ------------- | ------------- |
| Hospital admissions per 100 beds | previous_day_admission_adult_covid_confirmed_7_day_sum + previous_day_admission_adult_covid_suspected_7_day_sum +  previous_day_admission_pediatric_covid_confirmed_7_day_sum + previous_day_admission_pediatric_covid_suspected_7_day_sum |
| % Inpatient beds utilized | inpatient_beds_used/inpatient_beds |    
| % Hospital beds occupied by COVID-19 patients | (total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg + total_pediatric_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg)/inpatient_beds_7_day_avg |
| % Inpatient beds occupied by adult COVID patients  | total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg/ all_adult_hospital_inpatient_beds_7_day_avg |
| % Utilized inpatient beds that are for COVID patients | total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg /all_adult_hospital_inpatient_bed_occupied_7_day_avg  |
| % Adult ICU bed usage (COVID and non-COVID occupied)  | staffed_adult_icu_bed_occupancy_7_day_avg/ total_staffed_adult_icu_beds_7_day_avg  |
| % Staffed adult ICU bed usage (COVID occupied only) | staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg/ total_staffed_adult_icu_beds_7_day_avg  |

> Denominator of per 100 beds calculation is the
sum of average staffed inpatient bed count reported by hospitals within the geographic region and time period.

```{r metrics_df}
hospital_metrics <- df %>% 
  mutate(
    # Hospital admissions
    hospital_admissions = previous_day_admission_adult_covid_confirmed_7_day_sum + previous_day_admission_adult_covid_suspected_7_day_sum +  previous_day_admission_pediatric_covid_confirmed_7_day_sum + previous_day_admission_pediatric_covid_suspected_7_day_sum,
    # % Hospital beds occupied by COVID-19 patients
    beds_covid_occupied = (total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg + total_pediatric_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg)/inpatient_beds_7_day_avg,
    # % Inpatient beds occupied by adult COVID patients
    inpatient_beds_covid_occupied = total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg/ all_adult_hospital_inpatient_beds_7_day_avg,
    # % Adult inpatient care that are COVID patient
    inpatient_care_covid_prop = total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg /all_adult_hospital_inpatient_bed_occupied_7_day_avg,
    # % Staffed adult ICU bed usage (COVID and non-COVID occupied)
    icu_capacity_used = staffed_adult_icu_bed_occupancy_7_day_avg/ total_staffed_adult_icu_beds_7_day_avg,
    # % Staffed adult ICU bed usage (COVID occupied only)
    icu_capacity_covid_used = staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg/ total_staffed_adult_icu_beds_7_day_avg,
    # New COVID cases confirmed or suspected in the past week
    new_cases_confirmed_or_suspected = previous_day_admission_adult_covid_confirmed_7_day_sum + previous_day_admission_adult_covid_suspected_7_day_sum
  ) %>% 
  select(hospital_pk:is_metro_micro, inpatient_beds_7_day_avg, hospital_admissions:last_col())

# hospital_metrics %>% View()
```

Create the same county plots as in [Carlson School of Management dashboard](https://carlsonschool.umn.edu/mili-misrc-covid19-tracking-project)

>Note that %Hospital beds occupied by COVID-19 patients and %ICU beds occupied by COVID-19 patients are calculated at the facility level, and then averaged for each county for the week listed. As such, this dashboard presents the average COVID-19 occupancy of hospitals in a given county, not the ratio of the total COVID-19 patients in a county and the total beds in a county.

Some calculations are not reflected in the dashboard. For example

* Monongalia, WV
* Charlottesville city, VA
* Pawnee, KS is excluded

From their dashboard, it appears that missing values were imputed to 0, and -999,999 values were kept, but filtered out if subsquent calculations they resulted in negative values.

From their dashboard, it appears that pediatric patients were likely imputed to be 0 and any hospitals with adult COVID patient metrics missing are excluded. This makes sense because the virus is more aggressive the older you are, and missing values for pediatric metrics means most likely 0 pediatric patients.   Counties with only one reported hospital might be removed

```{r leaflet_map, eval = FALSE}
us_counties <- counties(cb = TRUE, resolution = "20m", progress_bar = FALSE) %>% 
  left_join(
    fips_codes %>% 
      select(starts_with("state")) %>% 
      distinct() %>% 
      as_tibble(),
     by = c("STATEFP" = "state_code")
  ) %>% 
  mutate(fips_code = as.numeric(paste0(STATEFP, COUNTYFP)))

tmap_mode("view")
hospital_metrics %>% 
  filter(collection_week == max(collection_week)) %>% 
  group_by(fips_code) %>% 
  # summarize(inpatient_beds_7_day_avg = sum(inpatient_beds_7_day_avg, na.rm = TRUE)) %>%
  summarize(
    hospital_admissions_rate = sum(hospital_admissions, na.rm = TRUE)/sum(inpatient_beds_7_day_avg, na.rm = TRUE)*100,
    # inpatient_beds_7_day_avg = sum(inpatient_beds_7_day_avg, na.rm = TRUE),
    # hospital_admissions = sum(hospital_admissions, na.rm = TRUE),
    # hospital_admissions_rate = hospital_admissions/inpatient_beds_7_day_avg*100,
    .groups = "drop"
  ) %>% 
  left_join(us_counties, by = "fips_code") %>% 
  filter(state == "OR") %>% 
  st_as_sf %>%
  # tm_shape(bbox = conus) +
  tm_shape() +
  tm_polygons("hospital_admissions_rate", breaks = c(0, 2, 4, 6, 11, 16, 21, Inf),
              id = "NAME", title = "Hospital admissions per 100 beds")
```

# State level breakdown

[FAQs](https://healthdata.gov/dataset/COVID-19-Reported-Patient-Impact-and-Hospital-Capa/6xf2-c3ie)

- **23** 


Patient impact and hospital capacity

  * https://healthdata.gov/Hospital/COVID-19-Reported-Patient-Impact-and-Hospital-Capa/g62h-syeh
  * https://healthdata.gov/dataset/COVID-19-Reported-Patient-Impact-and-Hospital-Capa/6xf2-c3ie


```{r}
state_utilization <- vroom("https://healthdata.gov/api/views/6xf2-c3ie/rows.csv?accessType=DOWNLOAD") %>% 
  # Staffing shortage metrics
  mutate(perc_staffing_shortage = critical_staffing_shortage_today_yes/(critical_staffing_shortage_today_yes + critical_staffing_shortage_today_no)) %>% 
  # Metrics convertable to readable labels
  mutate(
    shortage = glue::glue("{critical_staffing_shortage_today_yes}/{critical_staffing_shortage_today_yes + critical_staffing_shortage_today_no} ({critical_staffing_shortage_today_not_reported} NR)"),
    anticipated_shortage = paste(critical_staffing_shortage_anticipated_within_week_yes, critical_staffing_shortage_anticipated_within_week_yes +  critical_staffing_shortage_anticipated_within_week_no, sep = "/"),
    perc_inpatient_beds_used = inpatient_beds_used / inpatient_beds,
    frac_inpatient_beds_used = paste(inpatient_beds_used, inpatient_beds, sep = "/")
  )

us_states <- states(cb = TRUE, resolution = "20m", progress_bar = FALSE)

conus <- us_states %>% 
  filter(NAME %in% setdiff(state.name, c("Hawaii", "Alaska"))) %>% 
  st_bbox()
```

```{r}
# state_utilization %>% 
#   pull("perc_staffing_shortage") %>% 
#   summary()

tmap_mode("view")
us_states %>% 
  left_join(state_utilization, by = c("STUSPS" = "state")) %>% 
  tm_shape(bbox = conus) +
  tm_polygons("perc_staffing_shortage", id = "NAME", palette = "Oranges", 
              popup.vars = c(
                "Hospitals with staffing shortage" = "shortage",
                "Hospitals anticipating shortage" = "anticipated_shortage",
                "Inpatient beds used" = "perc_inpatient_beds_used"))
```

# County level breakdown

Below will be a sample state map broken by counties for Pennsylvania. The individual hospitals will be shown along with a table describing metrics.

# Timeseries for facility

There are many hospitals with the same name, so it's important to augment those with city and state information. A separate column will be added for this convenience when selecting hospitals from the shiny app.

```{r augment_names}
augmented_names <- df %>% 
  left_join(locations) %>% 
  distinct(hospital_pk, hospital_name, city, state) %>% 
  add_count(hospital_name) %>% 
  filter(n > 1) %>% 
  arrange(desc(n), hospital_name) %>% 
  mutate(augmented_name = glue::glue("{hospital_name} ({city}, {state})")) %>% 
  select(hospital_pk, augmented_name)

df <- df %>% left_join(augmented_names, by = "hospital_pk")
```


```{r}
theme_set(theme_bw())

hospital_metrics %>% 
  select(collection_week, hospital_name, is_metro_micro:last_col()) %>% 
  filter(hospital_name == "TEMPLE UNIVERSITY HOSPITAL") %>% 
  ggplot(aes(x = collection_week, y = beds_covid_occupied)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(labels = scales::label_percent()) +
  labs(title = "How full is the hospital with adult confirmed and suspected COVID patients?", x = NULL, y = NULL)
```
