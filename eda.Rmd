---
title: "R Notebook"
output:
  html_document:
    df_print: paged
    code_folding: "hide"
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
```

# Plan for dashboards

- (TODO) There should be an introduction or documentation page
- (TODO) First tab will have descriptive stats
  - Have filter based on state, region, etc
  - Group by metro/micro areas
  - no maps
- Second tab will show by individual states broken by counties
  - Interactive
  - (TODO) Will include hospital locations as well
  - (TODO) Will also contain a table to include data for hospitals without locations
- Last tab will show changes in metrics over time
  - (TODO) Add options to choose metrics (e.g. new cases, percent full, etc.)

# Introduction

I had found this data through "Data is Plural"

> On Monday, the Department of Health and Human Services released a dataset on coronavirus-related capacity at thousands of US hospitals —information the agency previously only published as state-level metrics. The self-reported, weekly-updated dataset quantifies various aspects of capacity, such as the number of staffed ICU beds and the number of beds occupied by patients with COVID-19. “This data is tremendously complex and is the result of substantial ongoing efforts,” notes an accompanying blog post. “We opted not to have perfect be the enemy of good, so these datasets will have imperfections.” Related: An FAQ “developed in collaboration with a group of data journalists, data scientists, and healthcare system researchers who have reviewed the data.” [h/t Ryan Panchadsaram]

[Tweet](https://twitter.com/rypan/status/1336095555852767233)

[Source](https://healthdata.gov/Hospital/COVID-19-Reported-Patient-Impact-and-Hospital-Capa/anag-cw7u)

[Github](https://github.com/CareSet/COVID_Hospital_PUF)

[Data Dictionary](https://healthdata.gov/covid-19-reported-patient-impact-and-hospital-capacity-facility-data-dictionary)

[Hospital Reporting FAQs](https://www.hhs.gov/sites/default/files/covid-19-faqs-hospitals-hospital-laboratory-acute-care-facility-data-reporting.pdf)

Questions from the FAQ found in the data:

- **1 a,b,d**: Hospital information
- **2 a,b**: # of inpatient and outpatient beds
- **3 a,b**: # of inpatient beds
- **4 a,b**: Inpatient bed occupancy
- **5 a,b**: # of ICU beds
- **6 a,b**: ICU bed occupancy
- **9 a,b**: # of hospitalized adult COVID patients
- **10 a,b**: # of hospitalized pediatric COVID patients
- **12 a,b**: # of hospitalized adult COVID patients in ICU
- **17 a-a9,b-b9**: Previous day adult COVID patient admission (to inpatient bed)
- **18 a,b**: Previous day pediatric COVID patient admission (to inpatient bed)
- **19**: Previous day ED visit
- **20**: Previous day COVID-related ED visit
- **33**: # of hospitalized adult influenza patients
- **34**: Previous day adult influenza patient admission (to inpatient bed)
- **35**: # of hospitalized adult influenza patients in ICU
- **36**: # of hospitalized adult with COVID and influenza

```{r libraries, message=FALSE}
library(tidyverse)
library(vroom)
library(sf)
library(tigris)
library(tmap)
```

The imported data will have some data cleaning steps. First, we will remove columns related to pediatric patients and change numeric -999,999 values to NA. 
This is done in the data loading file.

```{r read_and_clean_data, message=FALSE}
df <- vroom("data/reported_weekly_facility_level_capacity.csv") %>% 
  # No pediatric info
  select(-contains("pediatric"))
```

This dataset contains
`r length(unique(df$collection_week))`
weeks worth of data ( from
`r min(df$collection_week)`
to
`r max(df$collection_week)`
). There are
`r length(unique(df$hospital_pk))`
hospitals reporting, and are broken down by the following types:

There are many hospitals with the same name, so it's important to augment those with city and state information. A separate column will be added for this convenience.

```{r}
augmented_names <- df %>% 
  distinct(hospital_pk, hospital_name, city, state) %>% 
  add_count(hospital_name) %>% 
  filter(n > 1) %>% 
  arrange(desc(n), hospital_name) %>% 
  mutate(augmented_name = glue::glue("{hospital_name} ({city}, {state})")) %>% 
  select(hospital_pk, augmented_name)

df <- df %>% left_join(augmented_names)
```

# Plot sample map using census data and tmap

They have recently updated the information to include geocoded addresses. This information contains the latitude and longitude of the hospitals

Create the same county plots as in Carlson School of Management dashboard

[Millions Of Older Americans Live In Counties With No ICU Beds As Pandemic Intensifies](https://khn.org/news/as-coronavirus-spreads-widely-millions-of-older-americans-live-in-counties-with-no-icu-beds/)

## Calculating some metrics

| Example Metrics for Adult Hospitalizations  | Formula |
| ------------- | ------------- |
| How full is the hospital with adult confirmed and suspected COVID patients?  | total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg/ all_adult_hospital_inpatient_beds_7_day_avg |
| Total staffed adult ICU bed fullness? (including COVID and non-COVID ICU usage)  | staffed_adult_icu_bed_occupancy_7_day_avg/ total_staffed_adult_icu_beds_7_day_avg  |
| How full is the adult ICU of confirmed and suspected COVID patients? | staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg/ total_staffed_adult_icu_beds_7_day_avg  |
| What proportion of currently hospitalized adult patients are COVID patients?  | total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg /all_adult_hospital_inpatient_bed_occupied_7_day_avg  |

```{r metrics_df}
metrics_df <- df %>% 
  mutate(
    new_cases_confirmed_or_suspected = previous_day_admission_adult_covid_confirmed_7_day_sum + previous_day_admission_adult_covid_suspected_7_day_sum,
    adult_covid_prop =
      total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg/ all_adult_hospital_inpatient_beds_7_day_avg,
    staffed_adult_icu_beds_prop = staffed_adult_icu_bed_occupancy_7_day_avg/ total_staffed_adult_icu_beds_7_day_avg,
    staffed_adult_covid_icu_prop = staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg/ total_staffed_adult_icu_beds_7_day_avg) %>% 
  select(hospital_pk:is_metro_micro, new_cases_confirmed_or_suspected:last_col())

metrics_df
```

```{r join_facility_locations}
facility_locations <- metrics_df %>%
  inner_join(locations, by = c("hospital_name" = "NAME")) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = "EPSG: 4269")

facility_locations

# rm(df)
```

### County level breakdown

Below will be a sample state map broken by counties for Pennsylvania

```{r county_metrics, message=FALSE, warning=FALSE}
county_metrics <- metrics_df %>%
  filter(collection_week == "2020-12-11",
         state == "PA") %>% 
  mutate(across(where(is.numeric), ~ ifelse(is.nan(.x) | is.infinite(.x), NA, .x))) %>% 
  group_by(fips_code) %>% 
  summarize(
    hospital_count = sum(!is.na(new_cases_confirmed_or_suspected)),
    new_cases_confirmed_or_suspected = sum(new_cases_confirmed_or_suspected, na.rm = TRUE)
    )
  
us_counties <- counties(cb = TRUE, resolution = "20m") %>% 
  left_join(
    fips_codes %>% 
      select(starts_with("state")) %>% 
      distinct() %>% 
      as_tibble(),
     by = c("STATEFP" = "state_code")
  ) %>% 
  mutate(fips_code = paste0(STATEFP, COUNTYFP)) %>% 
  select(NAME, fips_code, state)

tmap_mode("view")
us_counties %>% 
  filter(state == "PA") %>%
  left_join(county_metrics, by = "fips_code") %>% 
  tm_shape() +
  tm_polygons("new_cases_confirmed_or_suspected") +
  tm_shape(facility_locations %>% filter(state == "PA")) +
  tm_dots()
```


### Timeseries for facility

```{r}
theme_set(theme_bw())

metrics_df %>% 
  select(collection_week, hospital_name, is_metro_micro:last_col()) %>% 
  filter(hospital_name == "TEMPLE UNIVERSITY HOSPITAL") %>% 
  ggplot(aes(x = collection_week, y = adult_covid_prop)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(labels = scales::label_percent()) +
  labs(title = "How full is the hospital with adult confirmed and suspected COVID patients?", x = NULL, y = NULL)
```


```{r knit_exit}
knitr::knit_exit()
```

# Extra notes

```{r plot_usmap, eval=FALSE}
library(usmap)

head(df$collection_week)
# How full is the hospital with adult confirmed and suspected COVID patients?
metric_1 <- df %>% 
  filter(all_adult_hospital_inpatient_beds_7_day_avg != 0,
         collection_week == "2020-12-11",
         !is.na(total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg),
         !is.na(all_adult_hospital_inpatient_beds_7_day_avg)) %>% 
  group_by(fips_code) %>% 
  summarize(percent_full = total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg/ all_adult_hospital_inpatient_beds_7_day_avg) %>% 
  ungroup() %>% 
  rename(fips = fips_code)

metric_1

plot_usmap(
  data = metric_1, values = "percent_full", region = "counties",
  include = "CA") + 
  theme(legend.position = "right") +
  scale_fill_gradient2(low = "white", mid = "orange", high = "red", midpoint = 0.5) +
  labs(title = "How full is the hospital with adult confirmed and suspected COVID patients?")
```

Create the same map using tmap

See this [issue](https://github.com/r-spatial/sf/issues/692) to see how to convert points to polygons

```{r eval=FALSE}
df_1 <- us_map(regions = "counties") %>% 
  st_as_sf(coords=c("x","y")) %>% 
  group_by(county, full, fips) %>% 
  summarise(do_union = FALSE) %>% 
  st_cast("POLYGON")
```

