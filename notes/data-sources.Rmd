---
title: "Data Sources For App"
output:
  html_document:
    toc: true
    df_print: paged
    code_folding: "hide"
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE, message=FALSE)
```

```{r libraries, message=FALSE}
library(tidyverse)
library(vroom)
```

## Community Profile Reports

[Source](https://healthdata.gov/Health/COVID-19-Community-Profile-Report/gqxm-d9w9)

[National level data](https://healthdata.gov/dataset/COVID-19-Community-Profile-Report-National-Level/gzn6-r8g2)

[County level data](https://healthdata.gov/dataset/COVID-19-Community-Profile-Report-County-Level/di4u-7yu6)

The Community Profile Report (CPR) is generated by the Data Strategy and Execution Workgroup in the Joint Coordination Cell, under the White House COVID-19 Team. It is managed by an interagency team with representatives from multiple agencies and offices (including the United States Department of Health and Human Services, the Centers for Disease Control and Prevention, the Assistant Secretary for Preparedness and Response, and the Indian Health Service). The CPR provides easily interpretable information on key indicators for all regions, states, core-based statistical areas (CBSAs), and counties across the United States. It is a snapshot in time that:

- Focuses on recent COVID-19 outcomes in the last seven days and changes relative to the week prior
- Provides additional contextual information at the county, CBSA, state and regional levels
- Supports rapid visual interpretation of results with color thresholds*

Data in this report may differ from data on state and local websites. This may be due to differences in how data were reported (e.g., date specimen obtained, or date reported for cases) or how the metrics are calculated. Historical data may be updated over time due to delayed reporting. Data presented here use standard metrics across all geographic levels in the United States. It facilitates the understanding of COVID-19 pandemic trends across the United States by using standardized data. The footnotes describe each data source and the methods used for calculating the metrics. For additional data for any particular locality, visit the relevant health department website. Additional data and features are forthcoming.


## United States COVID-19 Cases and Deaths by State over Time

[Source](https://data.cdc.gov/Case-Surveillance/United-States-COVID-19-Cases-and-Deaths-by-State-o/9mfq-cb36)

CDC reports aggregate counts of COVID-19 cases and death numbers daily online. Data on the COVID-19 website and CDC’s COVID Data Tracker are based on these most recent numbers reported by states, territories, and other jurisdictions. This data set of “United States COVID-19 Cases and Deaths by State over Time” combines this information. However, data are dependent on jurisdictions’ timely and accurate reporting.

Separately, CDC also regularly reports provisional death certificate data from the National Vital Statistics System (NVSS) on data.cdc.gov. Details are described on the NCHS website. Reporting the number of deaths by using death certificates ultimately provides more complete information but is a longer process; therefore, these numbers will be less than the death counts on the COVID-19 website.

## COVID-19 Reported Patient Impact and Hospital Capacity by State

Latest values obtained based on the last four days are obtained [here](https://healthdata.gov/dataset/COVID-19-Reported-Patient-Impact-and-Hospital-Capa/6xf2-c3ie). Weekly time series is also available [here](https://healthdata.gov/Hospital/COVID-19-Reported-Patient-Impact-and-Hospital-Capa/g62h-syeh)

## COVID-19 Reported Patient Impact and Hospital Capacity by Facility

[Source](https://healthdata.gov/Hospital/COVID-19-Reported-Patient-Impact-and-Hospital-Capa/anag-cw7u)

[Github](https://github.com/CareSet/COVID_Hospital_PUF)

[Hospital Reporting FAQs](https://www.hhs.gov/sites/default/files/covid-19-faqs-hospitals-hospital-laboratory-acute-care-facility-data-reporting.pdf)

```{r read_and_clean_data, message=FALSE, warning=FALSE}
df <- vroom(here::here("data","reported_patient_impact_hospital_capacity_facility.csv")) %>%
  select(hospital_pk:is_metro_micro, inpatient_beds_7_day_sum, 
         ends_with("avg"), starts_with("previous"),
         geocoded_hospital_address)
```

This dataset contains
`r length(unique(df$collection_week))`
weeks worth of data ( from
`r min(df$collection_week)`
to
`r max(df$collection_week)`
). There are
`r length(unique(df$hospital_pk))`
hospitals reporting. 
Most counties average
`r df %>% filter(collection_week == max(collection_week)) %>% count(fips_code) %>% arrange(desc(n)) %>% pull(n) %>% mean(na.rm = TRUE) `
hospitals in their area.
They have recently updated the information to include geocoded addresses. This information contains the latitude and longitude of the hospitals.

```{r location_info, eval = FALSE}
# Keep locations in separate dataframe
locations <- df %>%
  distinct(hospital_pk, state, city, address, zip, geocoded_hospital_address) %>% 
  replace_na(list(geocoded_hospital_address = "POINT EMPTY")) %>%
  st_as_sf(wkt = "geocoded_hospital_address", na.fail = FALSE)


# Remove corresponding column in df 
df <- df %>% 
  select(-c(state, city, address, zip,geocoded_hospital_address))

# left_join(locations, df, by = "hospital_pk", left = FALSE)
```


Questions from the FAQ found in the data are shown below. These are usually shown as sums or averages in a collection week

- **1 a,b,d**: Hospital information
- **2 a,b**: Total number of staffed inpatient and outpatient beds
  - total_beds_7_day_avg
  - all_adult_hospital_beds_7_day_avg
- **3 a,b**: Total number of staffed inpatient beds
  - inpatient_beds_7_day_avg
  - all_adult_hospital_inpatient_beds_7_day_avg
- **4 a,b**: Total number of staffed inpatient beds that are occupied
  - inpatient_beds_used_7_day_avg
  - all_adult_hospital_inpatient_bed_occupied_7_day_avg
- **5 a,b**: Total number of staffed inpatient ICU beds
  - total_icu_beds_7_day_avg
  - total_staffed_adult_icu_beds_7_day_avg
- **6 a,b**:  Total number of staffed inpatient ICU beds that are occupied
  - icu_beds_used_7_day_avg
  - staffed_adult_icu_bed_occupancy_7_day_avg
- **9 a,b**: Number of patients hospitalized in an adult inpatient bed
  - total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg
  - total_adult_patients_hospitalized_confirmed_covid_7_day_avg
- **10 a,b**: Number of patients hospitalized in a pediatric inpatient bed
  - total_pediatric_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg
  - total_pediatric_patients_hospitalized_confirmed_covid_7_day_avg
- **12 a,b**: Number of patients currently hospitalized in a designated adult ICU bed
  - staffed_icu_adult_patients_confirmed_and_suspected_covid_7_day_avg
  - staffed_icu_adult_patients_confirmed_covid_7_day_avg
- **17 a-a9,b-b9**: Previous day adult COVID patient admission (to inpatient bed)
- **18 a,b**: Previous day pediatric COVID patient admission (to inpatient bed)
<!-- - **19**: Previous day ED visit -->
<!-- - **20**: Previous day COVID-related ED visit -->
<!-- - **33**: # of hospitalized adult influenza patients -->
<!-- - **34**: Previous day adult influenza patient admission (to inpatient bed) -->
<!-- - **35**: # of hospitalized adult influenza patients in ICU -->
<!-- - **36**: # of hospitalized adult with COVID and influenza -->

### Carlson School of Management dashboard

Create the same county plots as in [Carlson School of Management dashboard](https://carlsonschool.umn.edu/mili-misrc-covid19-tracking-project)

>Note that %Hospital beds occupied by COVID-19 patients and %ICU beds occupied by COVID-19 patients are calculated at the facility level, and then averaged for each county for the week listed. As such, this dashboard presents the average COVID-19 occupancy of hospitals in a given county, not the ratio of the total COVID-19 patients in a county and the total beds in a county.

Some calculations are not reflected in the dashboard. For example

* Monongalia, WV
* Charlottesville city, VA
* Pawnee, KS is excluded

From their dashboard, it appears that missing values were imputed to 0, and -999,999 values were kept, but filtered out if subsquent calculations they resulted in negative values.

From their dashboard, it appears that pediatric patients were likely imputed to be 0 and any hospitals with adult COVID patient metrics missing are excluded. This makes sense because the virus is more aggressive the older you are, and missing values for pediatric metrics means most likely 0 pediatric patients.   Counties with only one reported hospital might be removed

```{r leaflet_map, eval = FALSE}
us_counties <- counties(cb = TRUE, resolution = "20m", progress_bar = FALSE) %>% 
  left_join(
    fips_codes %>% 
      select(starts_with("state")) %>% 
      distinct() %>% 
      as_tibble(),
     by = c("STATEFP" = "state_code")
  ) %>% 
  mutate(fips_code = as.numeric(paste0(STATEFP, COUNTYFP)))

tmap_mode("view")
hospital_metrics %>% 
  filter(collection_week == max(collection_week)) %>% 
  group_by(fips_code) %>% 
  # summarize(inpatient_beds_7_day_avg = sum(inpatient_beds_7_day_avg, na.rm = TRUE)) %>%
  summarize(
    hospital_admissions_rate = sum(hospital_admissions, na.rm = TRUE)/sum(inpatient_beds_7_day_avg, na.rm = TRUE)*100,
    # inpatient_beds_7_day_avg = sum(inpatient_beds_7_day_avg, na.rm = TRUE),
    # hospital_admissions = sum(hospital_admissions, na.rm = TRUE),
    # hospital_admissions_rate = hospital_admissions/inpatient_beds_7_day_avg*100,
    .groups = "drop"
  ) %>% 
  left_join(us_counties, by = "fips_code") %>% 
  filter(state == "OR") %>% 
  st_as_sf %>%
  # tm_shape(bbox = conus) +
  tm_shape() +
  tm_polygons("hospital_admissions_rate", breaks = c(0, 2, 4, 6, 11, 16, 21, Inf),
              id = "NAME", title = "Hospital admissions per 100 beds")
```

## Vaccine Hesitancy for COVID-19: County and local estimates

To support state and local communication and outreach efforts, ASPE developed state, county, and sub-state level predictions of hesitancy rates (https://aspe.hhs.gov/pdf-report/vaccine-hesitancy) using the most recently available federal survey data.

We estimate hesitancy rates at the state level using the U.S. Census Bureau’s Household Pulse Survey (HPS) (https://www.census.gov/programs-surveys/household-pulse-survey.html) data and utilize the estimated values to predict hesitancy rates at the Public Use Microdata Areas (PUMA) level using the Census Bureau’s 2019 American Community Survey (ACS) 1-year Public Use Microdata Sample (PUMS)(https://www.census.gov/programs-surveys/acs/microdata.html). To create county-level estimates, we used a PUMA-to-county crosswalk from the Missouri Census Data Center(https://mcdc.missouri.edu/applications/geocorr2014.html). PUMAs spanning multiple counties had their estimates apportioned across those counties based on overall 2010 Census populations.

The HPS is nationally representative and includes information on U.S. residents’ intentions to receive the COVID-19 vaccine when available, as well as other sociodemographic and geographic (state, region and metropolitan statistical areas) information. The ACS is a nationally representative survey, and it provides key sociodemographic and geographic (state, region, PUMAs, county) information. We utilized data for the survey collection period March 3, 2021 – March 15, 2021, which the HPS refers to as Week 26.

[Source](https://data.cdc.gov/Vaccinations/Vaccine-Hesitancy-for-COVID-19-County-and-local-es/q9mh-h2tw)

## COVID-19 Diagnostic Laboratory Testing (PCR Testing) Time Series

This time series dataset includes viral COVID-19 laboratory test [Polymerase chain reaction (PCR)] results from over 1,000 U.S. laboratories and testing locations including commercial and reference laboratories, public health laboratories, hospital laboratories, and other testing locations. Data are reported to state and jurisdictional health departments in accordance with applicable state or local law and in accordance with the Coronavirus Aid, Relief, and Economic Security (CARES) Act (CARES Act Section 18115).

[Source](https://healthdata.gov/dataset/COVID-19-Diagnostic-Laboratory-Testing-PCR-Testing/j8mb-icvb)

## COVID-19 Vaccine Distribution Allocations by Jurisdiction

Sources for [Pfizer](https://data.cdc.gov/Vaccinations/COVID-19-Vaccine-Distribution-Allocations-by-Juris/saz5-9hgg) and [Moderna](https://data.cdc.gov/Vaccinations/COVID-19-Vaccine-Distribution-Allocations-by-Juris/b7pe-5nws). [Janssen](https://data.cdc.gov/Vaccinations/COVID-19-Vaccine-Distribution-Allocations-by-Juris/w9zu-fywh) is also available, but it is paused for now to review data due to issues with rare cases of severe blood clots in women.

## COVID-19 Case Surveillance Public Use DataCase Surveillance

[Source](https://data.cdc.gov/Case-Surveillance/COVID-19-Case-Surveillance-Public-Use-Data/vbim-akqf)
